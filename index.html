<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Company Ads</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      background: #000000;
      overflow: hidden;
    }
    #slideshow {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #000000;
    }
    #slideshow img {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
      transition: opacity 0.5s ease-in-out;
    }
    #slideshow.paused {
      border: 5px solid #ff0000;
    }
    #slideshow.fade img {
      transition: opacity 1s ease-in-out;
    }
    #syncIndicator {
      position: fixed;
      top: 10px;
      left: 10px;
      padding: 10px 15px;
      background: rgba(0, 0, 0, 0.8);
      border-radius: 5px;
      font-family: Arial, sans-serif;
      font-size: 12px;
      color: white;
      z-index: 100;
      border-left: 4px solid #666;
    }
    #syncIndicator.synced {
      border-left-color: #00ff00;
      color: #00ff00;
    }
    #syncIndicator.local {
      border-left-color: #ffaa00;
      color: #ffaa00;
    }
    #alarmFlash {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      padding: 40px 60px;
      background: rgba(255, 0, 0, 0.9);
      border: 4px solid #ffff00;
      border-radius: 20px;
      font-family: Arial, sans-serif;
      font-size: 48px;
      font-weight: bold;
      color: #ffff00;
      z-index: 2000;
      text-align: center;
      animation: flashBounce 0.6s ease-in-out;
      box-shadow: 0 0 30px #ff0000, 0 0 60px #ffff00;
      text-shadow: 0 0 20px #ffff00;
    }
    @keyframes flashBounce {
      0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; }
      50% { transform: translate(-50%, -50%) scale(1.1); opacity: 1; }
      100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
    }
    #alarmFlash.show {
      display: flex;
      align-items: center;
      justify-content: center;
    }

    #adminPanel.open {
      display: flex;
    }
    #adminPanel h1 {
      font-size: 32px;
      margin: 0 0 20px 0;
      color: #ff0000;
      text-shadow: 0 0 10px #ff0000;
    }
    .admin-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      max-width: 1000px;
      width: 100%;
    }
    .admin-section {
      background: rgba(0, 255, 153, 0.1);
      border: 2px solid #00ff99;
      border-radius: 8px;
      padding: 15px;
      color: #00ff99;
    }
    .admin-section h2 {
      margin: 0 0 10px 0;
      font-size: 16px;
      border-bottom: 1px solid #00ff99;
      padding-bottom: 8px;
    }
    .admin-row {
      margin: 8px 0;
      display: flex;
      gap: 10px;
      align-items: center;
      font-size: 12px;
    }
    .admin-row label {
      min-width: 100px;
      color: #aaa;
    }
    .admin-row span {
      color: #00ff99;
      font-weight: bold;
    }
    .admin-row input {
      width: 60px;
      padding: 5px;
      background: rgba(0, 255, 153, 0.1);
      border: 1px solid #00ff99;
      color: #00ff99;
      border-radius: 4px;
    }
    .admin-btn {
      background: #00ff99;
      color: #000;
      border: none;
      padding: 8px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-weight: bold;
      font-size: 12px;
      margin: 5px;
    }
    .admin-btn:hover {
      background: #00dd77;
    }
    .admin-btn[onclick*="Alarm"],
    .admin-btn[onclick*="alarm"] {
      color: #ffffff !important;
      background: #ff0000 !important;
    }
    .admin-btn[onclick*="Alarm"]:hover,
    .admin-btn[onclick*="alarm"]:hover {
      background: #cc0000 !important;
    }
    #logViewer {
      background: rgba(0, 0, 0, 0.5);
      border: 1px solid #00ff99;
      border-radius: 4px;
      padding: 10px;
      max-height: 150px;
      overflow-y: auto;
      font-size: 11px;
      font-family: monospace;
      color: #0f0;
    }
    .log-entry {
      margin: 2px 0;
    }
    #adminClose {
      font-size: 12px;
      color: #666;
      margin-top: 20px;
    }
    .slider-container {
      display: flex;
      align-items: center;
      gap: 10px;
      width: 100%;
    }
    .slider-container input[type="range"] {
      flex: 1;
      height: 4px;
      background: rgba(0, 255, 153, 0.3);
      border-radius: 2px;
      outline: none;
    }
    .slider-container input[type="range"]::-webkit-slider-thumb {
      width: 15px;
      height: 15px;
      background: #00ff99;
      cursor: pointer;
      border-radius: 50%;
    }
    .slider-container span {
      min-width: 40px;
      text-align: right;
    }
    #emergencyOverlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: #ff0000;
      z-index: 500;
      align-items: center;
      justify-content: center;
      font-size: 48px;
      color: white;
      font-weight: bold;
      text-align: center;
      padding: 20px;
      animation: pulse 1s infinite;
    }
    #setupModal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0, 0, 0, 0.9);
      z-index: 2000;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      color: #00ff99;
      font-family: Arial, sans-serif;
    }
    #setupModal.show {
      display: flex;
    }
    #setupModal h1 {
      font-size: 36px;
      margin-bottom: 30px;
      color: #ff0000;
      text-shadow: 0 0 10px #ff0000;
    }
    #setupModal p {
      font-size: 18px;
      margin-bottom: 20px;
      color: #aaa;
    }
    #setupModal input {
      width: 300px;
      padding: 12px;
      font-size: 16px;
      background: rgba(0, 255, 153, 0.1);
      border: 2px solid #00ff99;
      color: #00ff99;
      border-radius: 4px;
      margin-bottom: 20px;
    }
    #setupModal button {
      background: #00ff99;
      color: #000;
      border: none;
      padding: 12px 30px;
      border-radius: 4px;
      cursor: pointer;
      font-weight: bold;
      font-size: 16px;
    }
    #setupModal button:hover {
      background: #00dd77;
    }
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }
  </style>
</head>
<body>
  <div id="syncIndicator" class="local">‚ö™ SYNCING...</div>
  
  <div id="alarmFlash"></div>
  
  <div id="emergencyOverlay"></div>
  
  <div id="slideshow">
    <img id="slide" src="ads/ad1.png" alt="Ad" />
  </div>

  <div id="adminPanel">
    <h1>üöÄ SUPREME COMMANDER KIM JONG UN ADMIN PANEL üöÄ</h1>
    
    <div class="admin-grid">
      <div class="admin-section">
        <h2>üìä System Status</h2>
        <div class="admin-row">
          <label>Sync Status:</label>
          <span id="statusSync">üü° Checking...</span>
        </div>
        <div class="admin-row">
          <label>Latency:</label>
          <span id="statusLatency">-ms</span>
        </div>
        <div class="admin-row">
          <label>Current Slide:</label>
          <span id="statusSlide">1/3</span>
        </div>
        <div class="admin-row">
          <label>Server Time:</label>
          <span id="statusTime">--:--:--</span>
        </div>
      </div>

      <div class="admin-section">
        <h2>‚öôÔ∏è Slideshow Control</h2>
        <div class="admin-row">
          <label>Duration (s):</label>
          <input type="number" id="durationInput" min="1" max="60" value="10">
          <button class="admin-btn" onclick="updateDuration()">Apply</button>
        </div>
        <div class="admin-row">
          <button class="admin-btn" onclick="prevSlide()">‚Üê Prev</button>
          <button class="admin-btn" onclick="nextSlide()">Next ‚Üí</button>
        </div>
        <div class="admin-row">
          <button class="admin-btn" id="pauseBtn" onclick="togglePause()">‚è∏Ô∏è Pause</button>
          <button class="admin-btn" onclick="toggleFullscreen()">‚õ∂ Fullscreen</button>
        </div>
      </div>

      <div class="admin-section">
        <h2>üé® Display Settings</h2>
        <div class="admin-row">
          <label>Brightness:</label>
          <div class="slider-container">
            <input type="range" id="brightnessSlider" min="50" max="150" value="100" oninput="updateBrightness()">
            <span id="brightnessValue">100%</span>
          </div>
        </div>
        <div class="admin-row">
          <label>Contrast:</label>
          <div class="slider-container">
            <input type="range" id="contrastSlider" min="50" max="150" value="100" oninput="updateContrast()">
            <span id="contrastValue">100%</span>
          </div>
        </div>
        <div class="admin-row">
          <button class="admin-btn" onclick="toggleTransitions()">‚ú® Toggle Fade</button>
          <button class="admin-btn" onclick="toggleAutoDim()">üåô Auto-Dim</button>
        </div>
      </div>

      <div class="admin-section">
        <h2>üîÑ Sync & Network</h2>
        <button class="admin-btn" onclick="manualSync()">Force Sync Now</button>
        <button class="admin-btn" onclick="checkLatency()">Check Latency</button>
      </div>

      <div class="admin-section">
        <h2>ÔøΩ Statistics</h2>
        <div class="admin-row">
          <label>Uptime:</label>
          <span id="statusUptime">0s</span>
        </div>
        <div class="admin-row">
          <label>Total Errors:</label>
          <span id="statusErrors">0</span>
        </div>
        <div class="admin-row">
          <label>Impressions:</label>
          <span id="statusImpressions">0</span>
        </div>
        <div class="admin-row">
          <label>Cycles:</label>
          <span id="statusCycles">0</span>
        </div>
      </div>

      <div class="admin-section">
        <h2>üîß Utilities</h2>
        <button class="admin-btn" onclick="reloadPage()">üîÑ Reload Page</button>
        <button class="admin-btn" onclick="clearLogs()">Clear Logs</button>
        <button class="admin-btn" onclick="exportLogs()">üíæ Export Logs</button>
        <button class="admin-btn" onclick="resetStats()">üìä Reset Stats</button>
        <button class="admin-btn" onclick="clearServerConfig()" style="background: #ff6600;">‚öôÔ∏è Reconfigure Server</button>
        <button class="admin-btn" onclick="toggleSyncAlarm()" style="background: #ff0000; color: #ffffff;">üö® Sync Alarm</button>
      </div>

      <div class="admin-section" style="grid-column: 1/-1;">
        <h2>üö® Emergency Broadcast</h2>
        <div class="admin-row">
          <input type="text" id="emergencyText" placeholder="Enter emergency message..." style="flex: 1; width: auto; min-width: 300px;">
          <button class="admin-btn" onclick="toggleEmergency()">üî¥ BROADCAST</button>
        </div>
      </div>

      <div class="admin-section" style="grid-column: 1/-1;">
        <h2>üìù System Log</h2>
        <div id="logViewer"></div>
      </div>
    </div>

    <div id="adminClose">Press ESC to close | Type 123 to reopen</div>
  </div>

  <script>
    const images = [
      "ads/ad1.png",
      "ads/ad2.png",
      "ads/ad3.png"
    ];
    
    let currentIndex = 0;
    let previousIndex = -1;
    const slideElement = document.getElementById("slide");
    const syncIndicator = document.getElementById("syncIndicator");
    const adminPanel = document.getElementById("adminPanel");
    const logViewer = document.getElementById("logViewer");
    let slideDuration = 30000; // 30 seconds per slide
    
    let isCheckingEmergency = false;
    
    // Sync indicator display
    const syncIndicatorElement = document.getElementById("syncIndicator");
    
    // Time sync variables
    let serverTimeOffset = 0;
    let syncedTime = false;
    let lastSyncLatency = 0;
    let currentAPI = ""; // Track which API is being used
    let systemLog = [];
    let keySequence = "";
    
    // Feature toggles and stats
    let isPaused = false;
    let fadeEnabled = false;
    let autoDimEnabled = false;
    let emergencyMode = false;
    let syncAlarmEnabled = false; // Warning sound for sync failures
    let alarmTestActive = false; // Track if 'A' key is held for alarm testing
    let alarmTestInterval = null;
    let currentAlarm = null; // Track current alarm playback
    let brightness = 100;
    let contrast = 100;
    let startTime = Date.now();
    let totalErrors = 0;
    let totalImpressions = 0;
    let totalCycles = 0;

    function addLog(msg) {
      const time = new Date().toLocaleTimeString();
      systemLog.push("[" + time + "] " + msg);
      if (systemLog.length > 50) systemLog.shift();
      updateLogView();
      console.log(msg);
    }

    function updateLogView() {
      if (logViewer) {
        logViewer.innerHTML = systemLog.map(l => '<div class="log-entry">' + l + '</div>').join('');
        logViewer.scrollTop = logViewer.scrollHeight;
      }
    }

    // Play TERRIFYING alarm sound from MP3 file
    function playAlarmSound(forcePlay = false) {
      if (!syncAlarmEnabled && !forcePlay) return;
      
      // Stop previous alarm if still playing
      if (currentAlarm) {
        currentAlarm.pause();
        currentAlarm.currentTime = 0;
      }
      
      // Create and play the alarm MP3
      currentAlarm = new Audio('syncalarm.mp3');
      currentAlarm.volume = 1.0; // Maximum volume
      currentAlarm.currentTime = 0; // Start from beginning
      currentAlarm.play().catch(err => console.log("Alarm play failed:", err));
      
      if (forcePlay) {
        addLog("üö® ALARM TEST - Hold 'A' to continue - MAXIMUM VOLUME WARNING");
      } else {
        addLog("üö® SYNC ALARM TRIGGERED - TERRIFYING ALERT - VOLUME AT MAXIMUM");
      }
    }
    
    // Start alarm testing (hold 'A' key)
    function startAlarmTest() {
      if (alarmTestActive) return;
      alarmTestActive = true;
      addLog("üö® ALARM TEST STARTED - Hold 'A' to continue, release to stop");
      
      // Play immediately
      playAlarmSound(true);
      
      // Play every 800ms while held
      alarmTestInterval = setInterval(() => {
        if (alarmTestActive) {
          playAlarmSound(true);
        }
      }, 800);
    }
    
    // Stop alarm testing (release 'A' key)
    function stopAlarmTest() {
      if (!alarmTestActive) return;
      alarmTestActive = false;
      if (alarmTestInterval) {
        clearInterval(alarmTestInterval);
        alarmTestInterval = null;
      }
      // Stop playing alarm immediately
      if (currentAlarm) {
        currentAlarm.pause();
        currentAlarm.currentTime = 0;
        currentAlarm = null;
      }
      addLog("‚úì ALARM TEST STOPPED");
    }

    function updateStatusDisplay() {
      const serverTime = getServerTime();
      if (document.getElementById("statusTime")) {
        document.getElementById("statusTime").textContent = new Date(serverTime).toLocaleTimeString();
      }
      if (document.getElementById("statusSlide")) {
        document.getElementById("statusSlide").textContent = (currentIndex + 1) + "/3";
      }
      if (document.getElementById("statusSync")) {
        document.getElementById("statusSync").textContent = syncedTime ? "üü¢ SYNCED" : "üü° LOCAL TIME";
      }
      if (document.getElementById("statusLatency")) {
        document.getElementById("statusLatency").textContent = lastSyncLatency + "ms";
      }
      
      // Update stats
      const uptime = Math.floor((Date.now() - startTime) / 1000);
      const hours = Math.floor(uptime / 3600);
      const mins = Math.floor((uptime % 3600) / 60);
      const secs = uptime % 60;
      const uptimeStr = hours > 0 ? hours + "h " + mins + "m" : mins > 0 ? mins + "m " + secs + "s" : secs + "s";
      
      if (document.getElementById("statusUptime")) {
        document.getElementById("statusUptime").textContent = uptimeStr;
      }
      if (document.getElementById("statusErrors")) {
        document.getElementById("statusErrors").textContent = totalErrors;
      }
      if (document.getElementById("statusImpressions")) {
        document.getElementById("statusImpressions").textContent = totalImpressions;
      }
      if (document.getElementById("statusCycles")) {
        document.getElementById("statusCycles").textContent = totalCycles;
      }
    }

    // Perfect millisecond sync using GitHub Pages server time
    async function syncServerTime() {
      const t0 = performance.now();
      
      try {
        // Fetch with GET to get server time from response headers
        const res = await Promise.race([
          fetch(window.location.href + "?t=" + Date.now(), { 
            method: "GET", 
            cache: "no-store"
          }),
          new Promise((_, reject) => setTimeout(() => reject(new Error("Timeout")), 5000))
        ]);
        
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        
        // Get server time from Date header
        const dateHeader = res.headers.get('date');
        if (!dateHeader) throw new Error("No date header in response");
        
        const serverMs = new Date(dateHeader).getTime();
        if (isNaN(serverMs)) throw new Error("Invalid date in header");
        
        const localMs = Date.now();
        const t1 = performance.now();
        lastSyncLatency = Math.round(t1 - t0);
        serverTimeOffset = serverMs - localMs;
        syncedTime = true;
        currentAPI = "GitHub Pages";
        
        addLog("‚úì SYNCED to GitHub Pages - latency: " + lastSyncLatency + "ms - offset: " + serverTimeOffset + "ms");
        syncIndicatorElement.className = "synced";
        syncIndicatorElement.textContent = "üü¢ GitHub Pages - " + lastSyncLatency + "ms";
        return true;
      } catch (err) {
        addLog("‚úó Sync failed: " + err.message);
        syncIndicatorElement.className = "error";
        syncIndicatorElement.textContent = "üî¥ SYNC ERROR";
        currentAPI = "";
        totalErrors++;
        
        // Play horrific alarm if enabled
        playAlarmSound();
        
        // Retry in 2 seconds
        setTimeout(syncServerTime, 2000);
        return false;
      }
    }

    function getServerTime() {
      return Date.now() + serverTimeOffset;
    }

    function updateSlide() {
      if (isPaused || emergencyMode) return;
      
      const serverTime = getServerTime();
      const cycleTime = serverTime % (slideDuration * images.length);
      const newIndex = Math.floor(cycleTime / slideDuration);
      
      if (newIndex !== currentIndex) {
        // Fade effect
        if (fadeEnabled) {
          slideElement.style.opacity = "0";
          setTimeout(() => {
            currentIndex = newIndex;
            slideElement.src = images[currentIndex];
            slideElement.style.opacity = "1";
          }, 500);
        } else {
          currentIndex = newIndex;
          slideElement.src = images[currentIndex];
        }
        
        totalImpressions++;
        console.log("Slide", currentIndex + 1, "| Server time:", new Date(serverTime).toISOString());
        
        // Auto-dim at night (10pm - 6am)
        if (autoDimEnabled) {
          const hour = new Date(serverTime).getHours();
          if (hour >= 22 || hour < 6) {
            if (brightness > 70) {
              brightness = 70;
              updateBrightness();
            }
          }
        }
        
        // Reload page when cycle completes (after showing all 3 ads)
        if (previousIndex === 2 && currentIndex === 0) {
          totalCycles++;
          addLog("Cycle complete - reloading page");
          setTimeout(() => location.reload(), 500);
        }
        
        previousIndex = currentIndex;
      }
    }

    function prevSlide() {
      currentIndex = (currentIndex - 1 + images.length) % images.length;
      slideElement.src = images[currentIndex];
      addLog("Manual slide change: " + (currentIndex + 1));
    }

    function nextSlide() {
      currentIndex = (currentIndex + 1) % images.length;
      slideElement.src = images[currentIndex];
      addLog("Manual slide change: " + (currentIndex + 1));
    }

    function updateDuration() {
      const input = document.getElementById("durationInput");
      const newDuration = parseInt(input.value) * 1000;
      if (newDuration >= 1000 && newDuration <= 60000) {
        slideDuration = newDuration;
        addLog("Slide duration changed to " + input.value + "s");
      }
    }

    // Setup and config functions
    function clearServerConfig() {
      addLog("No server configuration needed");
    }

    function manualSync() {
      addLog("Manual sync requested...");
      syncServerTime();
    }

    async function checkLatency() {
      try {
        const t0 = performance.now();
        const response = await fetch(window.location.href, { method: "HEAD", cache: "no-store" });
        const t1 = performance.now();
        const latency = Math.round(t1 - t0);
        lastSyncLatency = latency;
        addLog("Latency check: " + latency + "ms");
      } catch (err) {
        addLog("Latency check failed: " + err.message);
      }
    }

    function reloadPage() {
      if (confirm("Reload page? This will restart the slideshow.")) {
        addLog("Reloading page...");
        setTimeout(() => location.reload(), 500);
      }
    }

    function clearLogs() {
      systemLog = [];
      updateLogView();
      addLog("Logs cleared");
    }

    function togglePause() {
      isPaused = !isPaused;
      const btn = document.getElementById("pauseBtn");
      const slideshow = document.getElementById("slideshow");
      if (isPaused) {
        btn.textContent = "‚ñ∂Ô∏è Resume";
        slideshow.classList.add("paused");
        addLog("Slideshow paused");
      } else {
        btn.textContent = "‚è∏Ô∏è Pause";
        slideshow.classList.remove("paused");
        addLog("Slideshow resumed");
      }
    }

    function toggleFullscreen() {
      if (!document.fullscreenElement) {
        document.documentElement.requestFullscreen();
        addLog("Entered fullscreen");
      } else {
        document.exitFullscreen();
        addLog("Exited fullscreen");
      }
    }

    function updateBrightness() {
      brightness = document.getElementById("brightnessSlider").value;
      document.getElementById("brightnessValue").textContent = brightness + "%";
      applyFilters();
    }

    function updateContrast() {
      contrast = document.getElementById("contrastSlider").value;
      document.getElementById("contrastValue").textContent = contrast + "%";
      applyFilters();
    }

    function applyFilters() {
      slideElement.style.filter = "brightness(" + brightness + "%) contrast(" + contrast + "%)";
    }

    function toggleTransitions() {
      fadeEnabled = !fadeEnabled;
      const slideshow = document.getElementById("slideshow");
      if (fadeEnabled) {
        slideshow.classList.add("fade");
        addLog("Fade transitions enabled");
      } else {
        slideshow.classList.remove("fade");
        slideElement.style.opacity = "1";
        addLog("Fade transitions disabled");
      }
    }

    function toggleAutoDim() {
      autoDimEnabled = !autoDimEnabled;
      addLog("Auto-dim " + (autoDimEnabled ? "enabled" : "disabled"));
    }

    function showAlarmFlash() {
      const flashElement = document.getElementById("alarmFlash");
      const state = syncAlarmEnabled ? "üö® ALARM ENABLED" : "‚≠ï ALARM DISABLED";
      const color = syncAlarmEnabled ? "#ff0000" : "#ffff00";
      const textColor = syncAlarmEnabled ? "#ffffff" : "#ffff00";
      
      flashElement.textContent = state;
      flashElement.style.borderColor = color;
      flashElement.style.color = textColor;
      flashElement.style.textShadow = "0 0 20px " + textColor;
      flashElement.style.boxShadow = "0 0 30px " + color + ", 0 0 60px " + color;
      
      flashElement.classList.remove("show");
      flashElement.offsetHeight; // Force reflow to restart animation
      flashElement.classList.add("show");
      
      // Hide flash after animation
      setTimeout(() => {
        flashElement.classList.remove("show");
      }, 600);
    }
    
    function toggleSyncAlarm() {
      syncAlarmEnabled = !syncAlarmEnabled;
      addLog("üö® Sync alarm " + (syncAlarmEnabled ? "ENABLED - will play loud warning on sync failure" : "DISABLED"));
      if (!syncAlarmEnabled && currentAlarm) {
        currentAlarm.pause();
        currentAlarm.currentTime = 0;
        currentAlarm = null;
      }
      showAlarmFlash();
    }

    function toggleEmergency() {
      const overlay = document.getElementById("emergencyOverlay");
      const text = document.getElementById("emergencyText").value;
      
      if (!emergencyMode && text.trim()) {
        emergencyMode = true;
        overlay.textContent = text;
        overlay.style.display = "flex";
        addLog("üö® EMERGENCY MESSAGE DISPLAYED: " + text);
      } else {
        emergencyMode = false;
        overlay.style.display = "none";
        addLog("‚úì Emergency message cleared");
      }
    }

    // Check for emergency broadcasts from server (all devices poll for updates)
    async function checkEmergencyBroadcast() {
      // No server - emergency messages only work on this device
    }

    function exportLogs() {
      const logText = systemLog.join("\n");
      const blob = new Blob([logText], { type: "text/plain" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "slideshow-logs-" + new Date().toISOString().slice(0, 19).replace(/:/g, "-") + ".txt";
      a.click();
      URL.revokeObjectURL(url);
      addLog("Logs exported");
    }

    function resetStats() {
      if (confirm("Reset all statistics?")) {
        startTime = Date.now();
        totalErrors = 0;
        totalImpressions = 0;
        totalCycles = 0;
        addLog("Statistics reset");
        updateStatusDisplay();
      }
    }

    // Keyboard handler
    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape") {
        adminPanel.classList.remove("open");
        keySequence = "";
        return;
      }

      // Press 0 to force reload and resync
      if (e.key === "0") {
        addLog("Force reload triggered (key 0)");
        location.reload();
        return;
      }

      // Press F for fullscreen
      if (e.key === "f" || e.key === "F") {
        toggleFullscreen();
        return;
      }
      
      // Press T to toggle sync alarm and show state
      if ((e.key === "t" || e.key === "T") && !e.repeat) {
        toggleSyncAlarm();
        return;
      }
      
      // Hold 'A' to test alarm sound
      if ((e.key === "a" || e.key === "A") && !e.repeat) {
        startAlarmTest();
        return;
      }

      keySequence += e.key;
      if (keySequence.indexOf("123") !== -1) {
        adminPanel.classList.add("open");
        updateStatusDisplay();
        keySequence = "";
      }

      if (keySequence.length > 10) {
        keySequence = keySequence.slice(-10);
      }
    });
    
    // Handle key release for alarm testing
    document.addEventListener("keyup", (e) => {
      // Release 'A' to stop alarm test
      if (e.key === "a" || e.key === "A") {
        stopAlarmTest();
      }
    });

    // Initialize and start
    function start() {
      console.log("Initializing slideshow with", images.length, "images");
      console.log("Slide duration:", slideDuration / 1000, "seconds");
      
      addLog("Slideshow started - syncing for millisecond precision");
      
      // Sync immediately on startup
      syncServerTime();
      
      // Show initial slide immediately
      updateSlide();
      addLog("Slideshow initialized - " + images.length + " images, " + (slideDuration/1000) + "s per slide");
      
      // Update status display every 100ms
      setInterval(() => {
        updateSlide();
        if (adminPanel.classList.contains("open")) {
          updateStatusDisplay();
        }
      }, 100);
      
      // Resync every 2 seconds for ultra-fast millisecond accuracy across all devices
      setInterval(syncServerTime, 2000);
      
      // Poll Discord channel for broadcast messages every 2 seconds
      pollDiscordBroadcast();
      setInterval(pollDiscordBroadcast, 2000);
    }
    
    // Poll Discord channel for latest message
    async function pollDiscordBroadcast() {
      const CHANNEL_ID = "1459695675167084618";
      try {
        const res = await fetch(`https://discord.com/api/v10/channels/${CHANNEL_ID}/messages?limit=1`, {
          cache: 'no-store'
        });
        
        if (!res.ok) return;
        const messages = await res.json();
        
        if (messages.length > 0) {
          const message = messages[0];
          const overlay = document.getElementById("emergencyOverlay");
          overlay.textContent = message.content;
          overlay.style.display = "flex";
          overlay.style.background = "#ff0000";
          emergencyMode = true;
          addLog("üì° DISCORD BROADCAST: " + message.content);
        }
      } catch (err) {
        // Silently fail if API unavailable
      }
    }

    start();
  </script>
</body>
</html>

  <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-database.js"></script>
  <script>
    // FIREBASE CONFIG - Replace these with your values from Firebase Console
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      databaseURL: "https://YOUR_PROJECT.firebaseio.com"
    };
    
    // Initialize Firebase
    let db;
    try {
      firebase.initializeApp(firebaseConfig);
      db = firebase.database();
      
      // Listen for broadcast messages in real-time
      db.ref('broadcast/message').on('value', (snapshot) => {
        const message = snapshot.val();
        if (message && message.text) {
          // Display broadcast message
          const overlay = document.getElementById("emergencyOverlay");
          overlay.textContent = message.text;
          overlay.style.display = "flex";
          overlay.style.background = message.color || "#ff0000";
          emergencyMode = true;
          addLog("üì° BROADCAST RECEIVED: " + message.text);
        }
      });
    } catch (err) {
      console.log("Firebase not configured - broadcasts disabled. Set up Firebase to enable.");
    }
  </script>


