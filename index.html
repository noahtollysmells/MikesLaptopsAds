<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Company Ads</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      background: #000000;
      overflow: hidden;
    }
    #slideshow {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #000000;
    }
    #slideshow img {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
    }
    #syncIndicator {
      position: fixed;
      top: 10px;
      left: 10px;
      padding: 10px 15px;
      background: rgba(0, 0, 0, 0.8);
      border-radius: 5px;
      font-family: Arial, sans-serif;
      font-size: 12px;
      color: white;
      z-index: 100;
      border-left: 4px solid #666;
    }
    #syncIndicator.synced {
      border-left-color: #00ff00;
      color: #00ff00;
    }
    #syncIndicator.local {
      border-left-color: #ffaa00;
      color: #ffaa00;
    }
    #syncIndicator.error {
      border-left-color: #ff0000;
      color: #ff0000;
    }
    #adminPanel {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0, 0, 0, 0.95);
      z-index: 1000;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      font-family: Arial, sans-serif;
      color: #00ff99;
      padding: 20px;
      overflow-y: auto;
    }
    #adminPanel.open {
      display: flex;
    }
    #adminPanel h1 {
      font-size: 32px;
      margin: 0 0 20px 0;
      color: #ff0000;
      text-shadow: 0 0 10px #ff0000;
    }
    .admin-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      max-width: 1000px;
      width: 100%;
    }
    .admin-section {
      background: rgba(0, 255, 153, 0.1);
      border: 2px solid #00ff99;
      border-radius: 8px;
      padding: 15px;
      color: #00ff99;
    }
    .admin-section h2 {
      margin: 0 0 10px 0;
      font-size: 16px;
      border-bottom: 1px solid #00ff99;
      padding-bottom: 8px;
    }
    .admin-row {
      margin: 8px 0;
      display: flex;
      gap: 10px;
      align-items: center;
      font-size: 12px;
    }
    .admin-row label {
      min-width: 100px;
      color: #aaa;
    }
    .admin-row span {
      color: #00ff99;
      font-weight: bold;
    }
    .admin-row input {
      width: 60px;
      padding: 5px;
      background: rgba(0, 255, 153, 0.1);
      border: 1px solid #00ff99;
      color: #00ff99;
      border-radius: 4px;
    }
    .admin-btn {
      background: #00ff99;
      color: #000;
      border: none;
      padding: 8px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-weight: bold;
      font-size: 12px;
      margin: 5px;
    }
    .admin-btn:hover {
      background: #00dd77;
    }
    #logViewer {
      background: rgba(0, 0, 0, 0.5);
      border: 1px solid #00ff99;
      border-radius: 4px;
      padding: 10px;
      max-height: 150px;
      overflow-y: auto;
      font-size: 11px;
      font-family: monospace;
      color: #0f0;
    }
    .log-entry {
      margin: 2px 0;
    }
    #adminClose {
      font-size: 12px;
      color: #666;
      margin-top: 20px;
    }
  </style>
</head>
<body>
  <div id="syncIndicator" class="local">‚ö™ SYNCING...</div>
  
  <div id="slideshow">
    <img id="slide" src="ads/ad1.png" alt="Ad" />
  </div>

  <div id="adminPanel">
    <h1>üöÄ SUPREME COMMANDER KIM JONG UN ADMIN PANEL üöÄ</h1>
    
    <div class="admin-grid">
      <div class="admin-section">
        <h2>üìä System Status</h2>
        <div class="admin-row">
          <label>Sync Status:</label>
          <span id="statusSync">üü° Checking...</span>
        </div>
        <div class="admin-row">
          <label>Latency:</label>
          <span id="statusLatency">-ms</span>
        </div>
        <div class="admin-row">
          <label>Current Slide:</label>
          <span id="statusSlide">1/3</span>
        </div>
        <div class="admin-row">
          <label>Server Time:</label>
          <span id="statusTime">--:--:--</span>
        </div>
      </div>

      <div class="admin-section">
        <h2>‚öôÔ∏è Slideshow Control</h2>
        <div class="admin-row">
          <label>Duration (s):</label>
          <input type="number" id="durationInput" min="1" max="60" value="10">
          <button class="admin-btn" onclick="updateDuration()">Apply</button>
        </div>
        <div class="admin-row">
          <button class="admin-btn" onclick="prevSlide()">‚Üê Prev</button>
          <button class="admin-btn" onclick="nextSlide()">Next ‚Üí</button>
        </div>
      </div>

      <div class="admin-section">
        <h2>üîÑ Sync & Network</h2>
        <button class="admin-btn" onclick="manualSync()">Force Sync Now</button>
        <button class="admin-btn" onclick="checkLatency()">Check Latency</button>
      </div>

      <div class="admin-section">
        <h2>üîß Utilities</h2>
        <button class="admin-btn" onclick="reloadPage()">üîÑ Reload Page</button>
        <button class="admin-btn" onclick="clearLogs()">Clear Logs</button>
      </div>

      <div class="admin-section" style="grid-column: 1/-1;">
        <h2>üìù System Log</h2>
        <div id="logViewer"></div>
      </div>
    </div>

    <div id="adminClose">Press ESC to close | Type 123 to reopen</div>
  </div>

  <script>
    const images = [
      "ads/ad1.png",
      "ads/ad2.png",
      "ads/ad3.png"
    ];
    
    let currentIndex = 0;
    const slideElement = document.getElementById("slide");
    const syncIndicator = document.getElementById("syncIndicator");
    const adminPanel = document.getElementById("adminPanel");
    const logViewer = document.getElementById("logViewer");
    const slideDuration = 10000; // 10 seconds per slide
    
    // Time sync variables
    let serverTimeOffset = 0;
    let syncedTime = false;
    let lastSyncLatency = 0;
    let systemLog = [];
    let keySequence = "";

    function addLog(msg) {
      const time = new Date().toLocaleTimeString();
      systemLog.push("[" + time + "] " + msg);
      if (systemLog.length > 50) systemLog.shift();
      updateLogView();
      console.log(msg);
    }

    function updateLogView() {
      if (logViewer) {
        logViewer.innerHTML = systemLog.map(l => '<div class="log-entry">' + l + '</div>').join('');
        logViewer.scrollTop = logViewer.scrollHeight;
      }
    }

    function updateStatusDisplay() {
      const serverTime = getServerTime();
      if (document.getElementById("statusTime")) {
        document.getElementById("statusTime").textContent = new Date(serverTime).toLocaleTimeString();
      }
      if (document.getElementById("statusSlide")) {
        document.getElementById("statusSlide").textContent = (currentIndex + 1) + "/3";
      }
      if (document.getElementById("statusSync")) {
        document.getElementById("statusSync").textContent = syncedTime ? "üü¢ SYNCED" : "üü° LOCAL TIME";
      }
      if (document.getElementById("statusLatency")) {
        document.getElementById("statusLatency").textContent = lastSyncLatency + "ms";
      }
    }

    // Get accurate server time - TRY MULTIPLE SOURCES
    async function syncServerTime() {
      try {
        const t0 = performance.now();
        console.log("Attempting to sync with server time...");
        
        // Try multiple sync sources
        const syncSources = [
          { name: "worldtimeapi", url: "https://worldtimeapi.org/api/ip", parser: (data) => new Date(data.datetime).getTime() },
          { name: "cloudflare", url: "https://time.cloudflare.com/api/v1/now", parser: (data) => data.now_ms }
        ];
        
        let synced = false;
        
        for (const source of syncSources) {
          try {
            console.log("Trying sync source:", source.name);
            const response = await fetch(source.url, { cache: "no-store" });
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            
            const data = await response.json();
            const serverMs = source.parser(data);
            const localMs = Date.now();
            const t1 = performance.now();
            lastSyncLatency = Math.round(t1 - t0);
            serverTimeOffset = serverMs - localMs;
            syncedTime = true;
            synced = true;
            
            addLog("‚úì SYNCED with " + source.name + " (latency: " + lastSyncLatency + "ms)");
            syncIndicator.className = "synced";
            syncIndicator.textContent = "üü¢ SYNCED (" + source.name + " - " + lastSyncLatency + "ms)";
            return true;
          } catch (err) {
            console.warn("Failed with", source.name + ":", err.message);
          }
        }
        
        // If all sources failed, try HEAD request for Date header
        if (!synced) {
          console.log("Trying fallback: HEAD request for Date header");
          try {
            const response = await fetch(window.location.href, { method: "HEAD", cache: "no-store" });
            const dateHeader = response.headers.get("date");
            if (dateHeader) {
              const serverMs = new Date(dateHeader).getTime();
              const localMs = Date.now();
              const t1 = performance.now();
              lastSyncLatency = Math.round(t1 - t0);
              serverTimeOffset = serverMs - localMs;
              syncedTime = true;
              addLog("‚úì SYNCED via local server (latency: " + lastSyncLatency + "ms)");
              syncIndicator.className = "synced";
              syncIndicator.textContent = "üü¢ SYNCED (local - " + lastSyncLatency + "ms)";
              return true;
            }
          } catch (err) {
            console.warn("HEAD request failed:", err.message);
          }
        }
        
        throw new Error("All sync sources failed");
      } catch (err) {
        console.error("SYNC ERROR:", err.message);
        serverTimeOffset = 0;
        syncedTime = false;
        addLog("‚úó Sync failed: " + err.message);
        syncIndicator.className = "local";
        syncIndicator.textContent = "üü° OFFLINE";
        return false;
      }
    }

    function getServerTime() {
      return Date.now() + serverTimeOffset;
    }

    function updateSlide() {
      const serverTime = getServerTime();
      const cycleTime = serverTime % (slideDuration * images.length);
      const newIndex = Math.floor(cycleTime / slideDuration);
      
      if (newIndex !== currentIndex) {
        currentIndex = newIndex;
        slideElement.src = images[currentIndex];
        console.log("Slide", currentIndex + 1, "| Server time:", new Date(serverTime).toISOString());
      }
    }

    // Admin panel functions
    function nextSlide() {
      currentIndex = (currentIndex + 1) % images.length;
      slideElement.src = images[currentIndex];
      addLog("Manual slide change: " + (currentIndex + 1));
    }

    function prevSlide() {
      currentIndex = (currentIndex - 1 + images.length) % images.length;
      slideElement.src = images[currentIndex];
      addLog("Manual slide change: " + (currentIndex + 1));
    }

    function updateDuration() {
      const input = document.getElementById("durationInput");
      const newDuration = parseInt(input.value) * 1000;
      if (newDuration >= 1000 && newDuration <= 60000) {
        slideDuration = newDuration;
        addLog("Slide duration changed to " + input.value + "s");
      }
    }

    function manualSync() {
      addLog("Manual sync requested...");
      syncServerTime();
    }

    async function checkLatency() {
      try {
        const t0 = performance.now();
        const response = await fetch(window.location.href, { method: "HEAD", cache: "no-store" });
        const t1 = performance.now();
        const latency = Math.round(t1 - t0);
        lastSyncLatency = latency;
        addLog("Latency check: " + latency + "ms");
      } catch (err) {
        addLog("Latency check failed: " + err.message);
      }
    }

    function reloadPage() {
      if (confirm("Reload page? This will restart the slideshow.")) {
        addLog("Reloading page...");
        setTimeout(() => location.reload(), 500);
      }
    }

    function clearLogs() {
      systemLog = [];
      updateLogView();
      addLog("Logs cleared");
    }

    // Keyboard handler
    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape") {
        adminPanel.classList.remove("open");
        keySequence = "";
        return;
      }

      keySequence += e.key;
      if (keySequence.indexOf("123") !== -1) {
        adminPanel.classList.add("open");
        updateStatusDisplay();
        keySequence = "";
      }

      if (keySequence.length > 10) {
        keySequence = keySequence.slice(-10);
      }
    });

    // Initialize and start
    async function start() {
      console.log("Initializing slideshow with", images.length, "images");
      console.log("Slide duration:", slideDuration / 1000, "seconds");
      
      // Sync with server - TRY UP TO 5 TIMES
      let syncAttempts = 0;
      let synced = false;
      
      while (syncAttempts < 5 && !synced) {
        console.log("Sync attempt", syncAttempts + 1, "of 5");
        synced = await syncServerTime();
        if (!synced) {
          syncAttempts++;
          if (syncAttempts < 5) {
            await new Promise(r => setTimeout(r, 2000)); // Wait 2 seconds before retry
          }
        }
      }
      
      if (!synced) {
        console.error("FAILED TO SYNC AFTER 5 ATTEMPTS - Using local time as fallback");
        syncIndicator.textContent = "üü° USING LOCAL TIME (No network)";
      }
      
      // Show initial slide
      updateSlide();
      addLog("Slideshow initialized - " + images.length + " images, " + (slideDuration/1000) + "s per slide");
      
      // Update status display every 100ms
      setInterval(() => {
        updateSlide();
        if (adminPanel.classList.contains("open")) {
          updateStatusDisplay();
        }
      }, 100);
      
      // Resync every 5 minutes to stay accurate
      setInterval(syncServerTime, 300000);
    }

    start();
  </script>
</body>
</html>


